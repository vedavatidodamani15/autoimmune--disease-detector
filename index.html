<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Autoimmune Analyzer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container-card { max-width: 100%; margin: 2rem auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        .symptom-item { cursor: pointer; transition: all 0.2s ease-in-out; background-color: white; border: 1px solid #e5e7eb; }
        .symptom-item:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .selected { background-color: #e0f7fa; border-color: #00bcd4; font-weight: 600; color: #006064; }
        .result-box { border-left: 4px solid; transition: border-color 0.3s; }
        .result-box-high { border-color: #ef4444; } /* Red for high match */
        .result-box-medium { border-color: #f59e0b; } /* Amber for medium match */
    </style>
</head>
<body class="min-h-screen">

    <div class="container-card bg-white rounded-2xl p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex items-center justify-center space-x-3 mb-2">
                <i class="fa-solid fa-brain text-4xl text-cyan-600"></i>
                <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900">
                    Autoimmune Insight <span class="text-cyan-700">PRO</span>
                </h1>
            </div>
            <p class="text-sm text-gray-500 max-w-2xl mx-auto mt-2">A Multi-Factor Analyzer for complex symptom mapping and diagnostic prioritization.</p>
            <div class="mt-4 p-3 bg-red-50 border border-red-300 rounded-lg text-red-700 text-xs md:text-sm font-medium">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                DISCLAIMER: This is a research and educational tool, not a professional medical diagnosis. Consult a doctor.
            </div>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMN 1: SYMPTOM SELECTION -->
            <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner h-fit">
                <h2 class="text-xl font-extrabold mb-4 text-gray-800 flex items-center">
                    <i class="fa-solid fa-list-check mr-2 text-cyan-600"></i> 1. Select Symptoms
                </h2>
                
                <div class="relative mb-4">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="symptomSearch" placeholder="Search symptoms..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-sm">
                </div>

                <div class="flex justify-between items-center mb-3 text-sm">
                    <p class="font-medium text-gray-600">Selected: <span id="selectedCount" class="text-cyan-700 font-bold">0</span></p>
                    <button onclick="resetApp()" class="text-sm text-red-600 hover:text-red-800 transition duration-150 flex items-center">
                        <i class="fa-solid fa-rotate-right mr-1"></i>Reset
                    </button>
                </div>
                
                <!-- Symptom List Container -->
                <div id="symptomList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Symptoms injected here -->
                </div>
                
                <button id="analyzeButton" onclick="runAnalysis()" class="mt-6 w-full py-3 bg-cyan-700 text-white font-semibold rounded-lg hover:bg-cyan-800 transition duration-300 shadow-lg shadow-cyan-300 disabled:bg-gray-400 disabled:shadow-none" disabled>
                    <i class="fa-solid fa-chart-simple mr-2"></i> Run Multi-Factor Analysis
                </button>
            </div>

            <!-- COLUMN 2 & 3: ANALYSIS RESULTS -->
            <div class="lg:col-span-2">
                <section id="resultsSection" class="hidden space-y-6">
                    
                    <!-- Top Match Scores Graph -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-extrabold mb-4 text-gray-800 flex items-center">
                            <i class="fa-solid fa-chart-bar mr-2 text-blue-600"></i> 2. Top Match Scores (Bar Graph)
                        </h2>
                        <div class="h-64">
                            <canvas id="matchChart"></canvas>
                        </div>
                    </div>

                    <!-- Disease Matches List -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-extrabold mb-4 text-gray-800 flex items-center">
                            <i class="fa-solid fa-dna mr-2 text-green-600"></i> 3. Detailed Profile Matches
                        </h2>
                        <div id="analysisOutput" class="space-y-4">
                            <!-- Detailed results injected here -->
                        </div>
                    </div>

                    <!-- New Characterization Blocks -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Lifestyle Factor Character -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center">
                                <i class="fa-solid fa-running mr-2 text-yellow-600"></i> Lifestyle Factor Character
                            </h3>
                            <p id="lifestyleCharacter" class="text-gray-700 text-sm">Analyze your symptoms to characterize potential lifestyle factors...</p>
                        </div>

                        <!-- Body System Mapping Character -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center">
                                <i class="fa-solid fa-heart-pulse mr-2 text-red-600"></i> Body System Mapping
                            </h3>
                            <p id="bodySystemMapping" class="text-gray-700 text-sm">Analyze symptom location to identify affected systems...</p>
                        </div>
                        
                        <!-- Confidence Score + Explanation Character -->
                        <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-2">
                            <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center">
                                <i class="fa-solid fa-brain mr-2 text-indigo-600"></i> Confidence Score & Explanation
                            </h3>
                            <div id="confidenceOutput" class="space-y-2">
                                <p class="text-gray-700 text-sm">Confidence: <span id="confidenceScore" class="font-extrabold text-lg text-indigo-700">0%</span></p>
                                <p id="confidenceExplanation" class="text-gray-700 text-sm">This score reflects the diversity and specificity of the symptoms selected...</p>
                            </div>
                        </div>

                        <!-- Preventive Tips Character -->
                        <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-2">
                            <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center">
                                <i class="fa-solid fa-leaf mr-2 text-green-700"></i> Preventive Tips Character
                            </h3>
                            <ul id="preventiveTips" class="list-disc pl-5 text-sm space-y-2 text-gray-700">
                                <li>Tips related to potential autoimmune markers will appear here after analysis.</li>
                            </ul>
                        </div>
                    </div>

                </section>
            </div>
            
        </div>
    </div>

    <script>
        // --- DATA SETUP (Expanded for 14 Diseases, Systems, and Lifestyle Tags) ---
        const SYMPTOMS = {
            "1": "Persistent Fatigue", "2": "Joint Pain/Swelling", "3": "Morning Stiffness",
            "4": "Chronic Diarrhea/Abdominal Pain", "5": "Unintentional Weight Loss",
            "6": "Unintentional Weight Gain", "7": "Excessive Thirst/Urination",
            "8": "Facial Rash (Butterfly)", "9": "Scaly Skin Patches",
            "10": "Dry Eyes/Mouth", "11": "Rapid Heart Rate/Palpitations",
            "12": "Heat or Cold Sensitivity", "13": "Difficulty Walking/Coordination",
            "14": "Numbness/Tingling in Limbs", "15": "Vision Problems",
            "16": "Muscle Weakness", "17": "Recurring Low-Grade Fever",
            "18": "Constipation", "19": "Dry Skin/Brittle Hair",
            "20": "Hair Loss", "21": "Difficulty Swallowing", "22": "Chest Pain/Shortness of Breath",
            "23": "Sensitivity to Sunlight", "24": "Mouth Ulcers/Sores", "25": "Raynaud's Phenomenon (Cold/Blue Fingers)",
            "26": "Anxiety/Irritability", "27": "Low Blood Pressure/Dizziness"
        };
        
        // Define additional autoimmune diseases and their characteristic symptoms (Total 14)
        const DISEASE_PROFILES = {
            "Rheumatoid Arthritis (RA)": {keys: ["2", "3", "1", "17", "16"], systems: ["Musculoskeletal"], lifestyle: ["Inflammation", "Stress"], severity: 5},
            "Systemic Lupus Erythematosus (Lupus)": {keys: ["2", "8", "17", "1", "15", "23", "24"], systems: ["Connective Tissue", "Skin", "Renal"], lifestyle: ["Sun", "Inflammation"], severity: 7},
            "Multiple Sclerosis (MS)": {keys: ["1", "13", "14", "15", "16", "21"], systems: ["Neurological"], lifestyle: ["Stress", "Diet"], severity: 8},
            "Type 1 Diabetes": {keys: ["7", "5", "1", "15"], systems: ["Endocrine", "Metabolic"], lifestyle: ["Diet", "Metabolism"], severity: 6},
            "Graves' Disease (Hyperthyroidism)": {keys: ["5", "11", "12", "1", "26"], systems: ["Endocrine", "Cardiovascular"], lifestyle: ["Stress", "Metabolism"], severity: 5},
            "Hashimoto's Thyroiditis (Hypothyroidism)": {keys: ["6", "12", "18", "19", "1", "20"], systems: ["Endocrine", "Dermatological"], lifestyle: ["Diet", "Metabolism"], severity: 4},
            "Psoriasis/Psoriatic Arthritis (PsA)": {keys: ["9", "2", "3"], systems: ["Skin", "Musculoskeletal"], lifestyle: ["Inflammation", "Stress"], severity: 4},
            "Inflammatory Bowel Disease (IBD)": {keys: ["4", "5", "1", "17", "2"], systems: ["Gastrointestinal"], lifestyle: ["Diet", "Inflammation"], severity: 6},
            // Added 6 New Diseases
            "SjÃ¶gren's Syndrome": {keys: ["10", "1", "2", "24"], systems: ["Glandular", "Connective Tissue"], lifestyle: ["Stress", "Hydration"], severity: 5},
            "Addison's Disease": {keys: ["1", "5", "27", "17"], systems: ["Endocrine", "Cardiovascular"], lifestyle: ["Stress", "Fluid Balance"], severity: 7},
            "Systemic Sclerosis (Scleroderma)": {keys: ["21", "2", "25", "19"], systems: ["Connective Tissue", "Vascular", "GI"], lifestyle: ["Stress", "Circulation"], severity: 8},
            "Ankylosing Spondylitis (AS)": {keys: ["3", "2", "22", "17"], systems: ["Musculoskeletal", "Pulmonary"], lifestyle: ["Inflammation", "Movement"], severity: 6},
            "Celiac Disease": {keys: ["4", "5", "1", "18"], systems: ["Gastrointestinal", "Nutritional"], lifestyle: ["Diet", "Nutrients"], severity: 5},
            "Polymyalgia Rheumatica (PMR)": {keys: ["1", "2", "3", "17"], systems: ["Musculoskeletal"], lifestyle: ["Inflammation"], severity: 4}
        };

        const MIN_MATCHES = 2;
        let selectedSymptomKeys = new Set();
        let matchChartInstance = null; // For Chart.js instance

        // --- DOM Elements ---
        const symptomListEl = document.getElementById('symptomList');
        const selectedCountEl = document.getElementById('selectedCount');
        const analyzeButton = document.getElementById('analyzeButton');
        const searchInput = document.getElementById('symptomSearch');
        const resultsSection = document.getElementById('resultsSection');
        const analysisOutputEl = document.getElementById('analysisOutput');
        const lifestyleCharacterEl = document.getElementById('lifestyleCharacter');
        const bodySystemMappingEl = document.getElementById('bodySystemMapping');
        const confidenceScoreEl = document.getElementById('confidenceScore');
        const confidenceExplanationEl = document.getElementById('confidenceExplanation');
        const preventiveTipsEl = document.getElementById('preventiveTips');

        // --- CORE UI/STATE MANAGEMENT ---

        function renderSymptomList(filterText = '') {
            symptomListEl.innerHTML = '';
            const filter = filterText.toLowerCase();

            Object.entries(SYMPTOMS).forEach(([key, description]) => {
                if (description.toLowerCase().includes(filter)) {
                    const isSelected = selectedSymptomKeys.has(key);
                    const item = document.createElement('div');
                    item.className = `symptom-item p-3 rounded-lg text-sm flex justify-between items-center transition duration-150 ${isSelected ? 'selected' : 'hover:bg-gray-100'}`;
                    item.setAttribute('data-key', key);
                    item.onclick = () => toggleSymptom(key);
                    
                    item.innerHTML = `
                        <span class="font-medium">${description}</span>
                        <i class="fa-solid ${isSelected ? 'fa-check-circle text-cyan-700' : 'fa-circle text-gray-300'}"></i>
                    `;
                    symptomListEl.appendChild(item);
                }
            });
        }

        function updateUI() {
            selectedCountEl.textContent = selectedSymptomKeys.size;
            analyzeButton.disabled = selectedSymptomKeys.size < MIN_MATCHES;
            renderSymptomList(searchInput.value);
        }

        function toggleSymptom(key) {
            if (selectedSymptomKeys.has(key)) {
                selectedSymptomKeys.delete(key);
            } else {
                selectedSymptomKeys.add(key);
            }
            updateUI();
        }
        
        // --- ANALYSIS FUNCTIONS ---

        function analyzeSymptoms() {
            const matches = [];
            
            for (const [disease, profile] of Object.entries(DISEASE_PROFILES)) {
                let matched_count = 0;
                let matched_keys = new Set();
                
                profile.keys.forEach(requiredKey => {
                    if (selectedSymptomKeys.has(requiredKey)) {
                        matched_count++;
                        matched_keys.add(requiredKey);
                    }
                });

                if (matched_count >= MIN_MATCHES) {
                    // Calculate Match Percentage
                    const matchPercent = (matched_count / profile.keys.length) * 100;
                    
                    matches.push({ 
                        disease, 
                        count: matched_count, 
                        matchedKeys: matched_keys,
                        profileSize: profile.keys.length,
                        matchPercent: parseFloat(matchPercent.toFixed(1)),
                        systems: profile.systems,
                        lifestyle: profile.lifestyle,
                        severity: profile.severity
                    });
                }
            }
            
            // Sort by match count (descending) and then by match percentage
            matches.sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count;
                return b.matchPercent - a.matchPercent;
            });
            return matches;
        }
        
        // --- CHARACTERIZATION LOGIC ---
        
        function characterizeLifestyle(matches) {
            const lifestyleCounts = {};
            matches.forEach(match => {
                match.lifestyle.forEach(tag => {
                    lifestyleCounts[tag] = (lifestyleCounts[tag] || 0) + 1;
                });
            });
            
            if (Object.keys(lifestyleCounts).length === 0) return "No strong lifestyle factor pattern emerged from the matched diseases.";

            const sortedFactors = Object.entries(lifestyleCounts).sort((a, b) => b[1] - a[1]);
            const topFactor = sortedFactors[0][0];
            const explanation = {
                "Stress": "Symptoms often associated with inflammatory cycles triggered or worsened by high stress levels (e.g., RA, Lupus).",
                "Inflammation": "Strong clustering around pain, stiffness, and fever suggests a primary inflammatory process across multiple systems (e.g., PsA, IBD).",
                "Diet": "Symptoms linked to metabolic or gastrointestinal issues, suggesting dietary sensitivity or nutrient absorption problems (e.g., Celiac, Hashimoto's).",
                "Metabolism": "Core symptoms involve weight or energy balance, indicating potential endocrine/hormonal influence (e.g., Graves', Type 1 Diabetes)."
            };
            
            return `**Focus:** **${topFactor}** (Matched in ${sortedFactors[0][1]} profiles). <br> *${explanation[topFactor] || 'General autoimmune pathway detected.'}*`;
        }
        
        function mapBodySystems(matches) {
            const systemCounts = {};
            matches.forEach(match => {
                match.systems.forEach(system => {
                    systemCounts[system] = (systemCounts[system] || 0) + 1;
                });
            });
            
            if (Object.keys(systemCounts).length === 0) return "Symptom locations are too diverse or non-specific for system mapping.";

            const sortedSystems = Object.entries(systemCounts).sort((a, b) => b[1] - a[1]);
            const topSystem = sortedSystems[0][0];
            
            const explanation = sortedSystems.map(([system, count]) => 
                `<span class="font-bold text-blue-800">${system}</span> (${count} profiles)`
            ).join(', ');
            
            return `**Primary System:** **${topSystem}**. <br> *Cluster across: ${explanation}. This suggests systemic involvement of these areas.*`;
        }

        function calculateConfidence(matches) {
            if (selectedSymptomKeys.size === 0) return { score: 0, explanation: "No symptoms selected." };
            if (matches.length === 0) return { score: 20, explanation: "Symptoms were selected, but did not meet the minimum match threshold for common profiles." };
            
            // Score is based on Max Match Count relative to Max possible, and number of symptoms selected.
            const maxMatch = matches[0].count;
            const specificityFactor = Array.from(selectedSymptomKeys).filter(key => ["8", "10", "13", "25", "27"].includes(key)).length; // Unique symptoms increase confidence
            
            let score = (maxMatch / 5) * 40 + (specificityFactor * 10);
